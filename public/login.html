<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Dunbar Users Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <style>
        #msg {
            color: green;
            font-weight: bold;
        }
    
        #intro {
            color: #979A9E;
            font-size: 12pt;
        }
    
        body {
            font-family: 'Open Sans', sans-serif;
            color: #979A9E;
            background-color: #2F353E;
        }
    
        input[type="text"] {
            background-color: #ccc;
            color: black;
            font-weight: bold;
            font-family: serif;
            font-size: 14pt;
        }
    
        h1 {
            cursor: pointer;
            font-weight: 300;
            font-family: 'Raleway', sans-serif;
            margin-bottom: 10px;
        }
    
        .navbar-brand {
            float: none;
            font-size: 2rem;
            line-height: 1.5;
            margin-bottom: 20px;
        }
    
        .panel-body {
            color: initial;
        }
    
        .panel {
            word-break: break-word;
        }
    
        .status_header {
            color: gray;
        }
    
        #a_t {
            height: 170px;
            margin-bottom: 8px;
        }
    
        #a_t,
        #r_t_4_a_t,
        #new_refresh_token {
            margin-bottom: 8px;
        }
    
        #code_for_refresh_token {
            margin-bottom: -13px;
        }
    </style>
</head>

<body class="container">
    <h1 onclick="window.location='https://dunbar-users.rerum.io'" target="_blank" class="navbar-brand"><i class="fa fa-cubes"></i>
        dunbar</h1>
    <div class='' id="intro">
        <p>
            We are so glad you are interested in researching the works of Paul Dunbar.
        </p>
    </div>
    <div class='panel panel-info' name="block">
        <div class="panel-heading"> <span class="panel-title">Dunbar App Registration</span> </div>
        <div class="panel-body">
            <p class="handHoldy">
                After registering, you will be returned to this page with an Auth0 Token with your agent encoded or a response with the agent in it or something, whatever. <br>
            </p>
        </div>
        <div class="panel-footer">
            <input class='btn btn-primary btn-large' type="button" id="register" value="Register with the Dunbar App" />
        </div>
    </div>
    <div class='panel panel-info' name="block">
        <div class="panel-heading"> <span class="panel-title">Existing User Login</span> </div>
        <div class="panel-body">
            <p class="handHoldy">
                If you have registered with the Dunbar app already, login below.
            </p>
            <div>
                <span class="status_header"> Dunbar App Agent </span>
                <kbd class="rerumStatus" id="agentLink">NOT LOGGED</kbd>
            </div>
        </div>
        <div class="panel-footer">
            <input class='btn btn-primary btn-large' type="button" id="login"
                value="Login To Dunbar App" />
        </div>
    </div>
    <script type="text/javascript">
        let agent_uri = ""
        let agent_access_token = ""
        let auth_code = ""
        let error_code = ""
        let responseJSON = {}
        let myURL = document.location.href
        let token = sessionStorage.getItem("Dunbar-Token")
        let agent = sessionStorage.getItem("Agent-URI")

        //Auth0 Login Widget was successful and it redirect here with the access token in the URL.
        //Put the token in session storage and refresh the page.  We don't want it in the address bar.
        if (myURL.indexOf("access_token=") > -1) {
            //Auth0 adds this to redirects.  Remove it from the address bar.
            sessionStorage.setItem('Dunbar-Token', getURLHash("access_token"))
            document.location.href="login.html"
        }
        else if(token){
            //A token was in sessionStorage, so there was a login during this window session.
            //An access token is stored. Let's use it to get the user info.  If it fails, the user needs to login again.
            fetch('/client/dunbar-user?access_token='+token)
            .then(res => res.json())
            .then(u => {
                console.log("I know the user now.")
                console.log(u)
                let a = u["http://store.rerum.io/agent"]
                agentLink.innerHTML = a
                sessionStorage.setItem('Agent-URI', a)
                alert(`Hello ${a}!`)
            })
            .catch(err =>{
                console.error(err)
                sessionStorage.removeItem('Agent-URI')
                sessionStorage.removeItem('Dunbar-Token')
                agentLink.innerHTML = "Please login again.  Your session expired."
                alert("You logged out or your session expired.  Try logging in again.")
            })     
        }
        else{
            //They need to log in!
        }
            
        $("#register").click(ev => fetch('/client/connect')
        .then(res => {
            console.log(res)
            return res.text()
        })
        .then(url => location.href = url))

        //Go off to Auth0, come back with an Agent ID (upon successful login) or null (unsuccessful login)
        $("#login").click(ev => fetch('/client/connect')
        .then(res => {
            console.log(res)
            return res.text()
        })
        .then(url => location.href = url))

        function getURLVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] == variable) { return pair[1]; }
            }
            return false;
        }

        function getURLHash(variable, url=document.location.href) {
            var query = document.location.hash;
            query = query.substr(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] == variable) { return pair[1]; }
            }
            return false;
        }

        /** Auth0 Heartbeat that keeps the access token fresh. Apps' responsibility.*/
        setTimeout(async function(){
          if(sessionStorage.getItem("Dunbar-Token")){
            //You are registered/logged in but you access token has expired b/c it has a short life.  Silently refresh it if possible.
            try{
              let resp = await fetch("/client/revalidate").then(res=>res.json()).catch(err=>{return {}})
              //This URL has an #access_token or #error
              let error = resp.error ?? ""
              let t = resp.access_token ?? ""
              if(t){
                //This user has continued their session, we we got a new token and can store it
                sessionStorage.setItem("Dunbar-Token", t)  
              }
              else{
                //This user did not continue their session, and so needs to log in again.
                sessionStorage.removeItem("Dunbar-Token")
                sessionStorage.removeItem("Agent-URI") 
                console.log("Could not authorize silently.  Please login again.")
                console.error(error)
                //document.location.href = "login.html"
              }
            }
            catch (e) {
              //The authorize endpoint errored out and we could not validate you.  Please login again.
              console.log("got to authorize error")
              console.error(e)
              sessionStorage.removeItem("Dunbar-Token")
              sessionStorage.removeItem("Agent-URI")
            }
          }
          else{
            //You need to login to start a session!
          }
        }, 20000)

    </script>
</body>

</html>
