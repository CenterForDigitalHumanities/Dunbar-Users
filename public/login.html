<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Dunbar Users Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <style>
        #msg {
            color: green;
            font-weight: bold;
        }
    
        #intro {
            color: #979A9E;
            font-size: 12pt;
        }
    
        body {
            font-family: 'Open Sans', sans-serif;
            color: #979A9E;
            background-color: #2F353E;
        }
    
        input[type="text"] {
            background-color: #ccc;
            color: black;
            font-weight: bold;
            font-family: serif;
            font-size: 14pt;
        }
    
        h1 {
            cursor: pointer;
            font-weight: 300;
            font-family: 'Raleway', sans-serif;
            margin-bottom: 10px;
        }
    
        .navbar-brand {
            float: none;
            font-size: 2rem;
            line-height: 1.5;
            margin-bottom: 20px;
        }
    
        .panel-body {
            color: initial;
        }
    
        .panel {
            word-break: break-word;
        }
    
        .status_header {
            color: gray;
        }
    
        #a_t {
            height: 170px;
            margin-bottom: 8px;
        }
    
        #a_t,
        #r_t_4_a_t,
        #new_refresh_token {
            margin-bottom: 8px;
        }
    
        #code_for_refresh_token {
            margin-bottom: -13px;
        }
    </style>
</head>

<body class="container">
    <h1 onclick="window.location='login.html'" target="_blank" class="navbar-brand"><i class="fa fa-cubes"></i>
        dunbar</h1>
    <div class='' id="intro">
        <p>
            We are so glad you are interested in researching the works of Paul Dunbar.
        </p>
    </div>
    <div class='panel panel-info' name="block">
        <div class="panel-heading"> <span class="panel-title">Admin Login</span> </div>
        <div class="panel-body">
            <p class="handHoldy">
                Admins can log in below.
            </p>
            <div>
                <span class="status_header"> Dunbar App Agent </span>
                <kbd class="rerumStatus" id="agentLink">NOT LOGGED</kbd>
            </div>
        </div>
        <div class="panel-footer">
            <input class='btn btn-primary btn-large' type="button" id="login"
                value="Login To Dunbar User Management" />
        </div>
    </div>
    <script src="https://cdn.auth0.com/js/auth0/9.19.0/auth0.min.js"></script>
    <script type="text/javascript" src="./script/heart.js"></script>
    <script type="text/javascript">
        const AUDIENCE = "https://cubap.auth0.com/api/v2/"
        const ISSUER_BASE_URL = "cubap.auth0.com"
        const CLIENTID = "z1DuwzGPYKmF7POW9LiAipO5MvKSDERM"
        const DUNBAR_REDIRECT = "http://localhost:3000/manage.html"
        const DOMAIN = "cubap.auth0.com"

        let webAuth = null
        let manager = null

        //Keep these in session when appropriate, to help avoid as many async calls as possible.

        //This is an Auth0 Bearer, a management access token
        let token = sessionStorage.getItem("Dunbar-Token")
        //This is a RERUM v1 Agent
        let agent = sessionStorage.getItem("Agent-URI")
        //This is an Auth0 User Profile
        //TODO how do i know if this user is an admin?
        let user = sessionStorage.getItem("Dunbar-User")

        if(token){
            //A token was in sessionStorage, so there was a login during this window session.
            //This manager cannot be used to access OTHER USERS' info
            manager = new auth0.Management({
              "domain": DOMAIN,
              "token": token
            })
            //An access token is stored. Let's use it to get THIS USER's info.  If it fails, the user needs to login again.
            manager.getUser(user.sub, function(err, u){
                if(err){

                }
                else{
                    console.log("I know the user now.")
                    console.log(u)
                    let a = u["http://store.rerum.io/agent"]
                    agentLink.innerHTML = a
                    sessionStorage.setItem('Agent-URI', a)
                    sessionStorage.setItem('Dunbar-User', u)
                    alert(`Hello ${a}!`)    
                }
            })
            //Get users from our back end?
            /*
                fetch('/client/dunbar-user?access_token='+token)
                .then(res => res.json())
                .then(u => {
                    console.log("I know the user now.")
                    console.log(u)
                    let a = u["http://store.rerum.io/agent"]
                    agentLink.innerHTML = a
                    sessionStorage.setItem('Agent-URI', a)
                    sessionStorage.setItem('Dunbar-User', u)
                    alert(`Hello ${a}!`)
                })
                .catch(err =>{
                    console.error(err)
                    sessionStorage.removeItem('Agent-URI')
                    sessionStorage.removeItem('Dunbar-Token')
                    sessionStorage.removeItem('Dunbar-User')
                    agentLink.innerHTML = "Please login again.  Your session expired."
                    alert("You logged out or your session expired.  Try logging in again.")
                })     
            */
        }
        else{
            //They need to log in!
        }

        //send them off to Universal Login and bring them back here with #access_token
        $("#login").click(ev => {
            webAuth = new auth0.WebAuth({
                domain:       ISSUER_BASE_URL,
                clientID:     CLIENTID
            })
            webAuth.authorize({
                "audience":AUDIENCE,
                "scope":"read:users update:users profile openid offline_access",
                "redirectUri": DUNBAR_REDIRECT,
                "responseType" : "token",
                "clientId" : CLIENTID,
                "state" : "dunbar123"
              //Any additional options can go here
            })
        })     

        //Use the Universal Client Login via our own back end
        /*
        $("#login").click(ev => fetch('/manage/connect')
        .then(res => {
            console.log(res)
            return res.text()
        })
        .then(url => location.href = url))
        */

        //Do it with a popup
        //Hmm this wasn't quite what I thought.

        /*
        $("#login").click(ev => {
            webAuth = new auth0.WebAuth({
                domain:       ISSUER_BASE_URL,
                clientID:     CLIENTID
            })
            webAuth.popup.authorize({
                "audience":AUDIENCE,
                "scope":"read:users update:users profile openid offline_access",
                "redirectUri": DUNBAR_REDIRECT,
                "responseType" : "token",
                "clientId" : CLIENTID,
                "state" : "dunbar123",
                "autoClose" : true
              //Any additional options can go here
            }, function(err, authResult) {
                webAuth.client.userInfo(authResult.accessToken, function(err, u) {
                    console.log("I know the user trying to log in now.")
                    console.log(u)
                    let agentURI = u["http://store.rerum.io/agent"]
                    agent = agentURI
                    token = authResult.accessToken
                    user = u
                    sessionStorage.setItem('Agent-URI', agentURI)
                    sessionStorage.setItem('Dunbar-Token', authResult.accessToken)
                    sessionStorage.setItem('Dunbar-User', u)
                })
            })
            webAuth.popup.callback()
        })
        */

    </script>
</body>

</html>
