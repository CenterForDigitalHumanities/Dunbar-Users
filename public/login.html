<!DOCTYPE html>
<html lang="en-us">

    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>Dunbar Users Portal</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="./style/style.css">
    </head>
    <body>
        <header class="container">
            <nav class="nav">
                <div class="nav-left">
                    <a class="brand" href="login.html"><img
                            src="https://cdm16007.contentdm.oclc.org/iiif/2/p267401coll32:4553/100,0,1100,1100/150,150/0/default.jpg"
                            alt="logo"></a>
                    <h1 class="brand text-light">
                        Dunbar Library &amp; Archive Users&nbsp;
                        <i class="fa fa-cubes"></i>
                    </h1>
                </div>
                <div class="nav-right">
                </div>
            </nav>
        </header>
            <div class='container'>
            <p>
                We are so glad you are interested in researching the works of Paul Dunbar.
            </p>
        <div class='panel panel-info' name="block">
            <div class="panel-heading"> <span class="panel-title">Admin Login</span> </div>
            <div class="panel-body">
                <p class="handHoldy">
                    Please login below.  If you do not have a Dunbar Apps account, you will have the option to register for one.
                </p>
                <div>
                    <span class="status_header"> Dunbar App Agent </span>
                    <kbd class="rerumStatus" id="userName">NOT LOGGED IN</kbd>
                </div>
            </div>
            <div class="panel-footer">
                <input class='btn btn-primary btn-large' type="button" id="login"
                    value="Login To Dunbar User Management" />
            </div>
        </div>
        <script src="https://cdn.auth0.com/js/auth0/9.19.0/auth0.min.js"></script>
        <script type="text/javascript">
            const AUDIENCE = "https://cubap.auth0.com/api/v2/"
            const CLIENTID = "z1DuwzGPYKmF7POW9LiAipO5MvKSDERM"
            const DUNBAR_REDIRECT = origin+"/manage.html"
            const DOMAIN = "cubap.auth0.com"
            let webAuth = null
            //This is an Auth0 Bearer, a management access token
            let token = sessionStorage.getItem("Dunbar-Login-Token")
            //This is a RERUM v1 Agent
            if(token){
                let authenticator = new auth0.Authentication({
                    domain:       DOMAIN,
                    clientID:     CLIENTID
                })
                //An access token is stored. Let's use it to get THIS USER's info.  If it fails, the user needs to login again.
                authenticator.userInfo(token, function(err, u){
                    if(err){
                        alert("Your session may have expired.  Please login again.")
                    }
                    else{
                        window.location="manage.html"
                    }
                })
            }
            else{
                //They need to log in!
                alert("Your session may have expired.  Please login again.")
            }

            /**
             *  When they click login send them off the Auth0 Universal Login.
             *  This app back end needs access token level scope for managing other users in user management.
             *  For non-admins, some of the front end needs ID token level scope for managing the current user.
             *  This is covered by using both token types in responseType.
             */  
            login.onclick = ev => {
                webAuth = new auth0.WebAuth({
                    "domain":       DOMAIN,
                    "clientID":     CLIENTID,
                    "audience":   AUDIENCE
                })
                webAuth.authorize({
                    "authParamsMap": {'app': 'dla'},
                    "scope":"read:roles update:current_user_metadata name nickname picture email profile openid offline_access",
                    "redirectUri": DUNBAR_REDIRECT,
                    "responseType" : "id_token token"
                })
            }
        </script>
    </body>

</html>
