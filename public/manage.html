<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Dunbar Users Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <style>
        #msg {
            color: green;
            font-weight: bold;
        }
    
        #intro {
            color: #979A9E;
            font-size: 12pt;
        }
    
        body {
            font-family: 'Open Sans', sans-serif;
            color: #979A9E;
            background-color: #2F353E;
        }
    
        input[type="text"] {
            background-color: #ccc;
            color: black;
            font-weight: bold;
            font-family: serif;
            font-size: 14pt;
        }
    
        h1 {
            cursor: pointer;
            font-weight: 300;
            font-family: 'Raleway', sans-serif;
            margin-bottom: 10px;
        }
    
        .navbar-brand {
            float: none;
            font-size: 2rem;
            line-height: 1.5;
            margin-bottom: 20px;
        }
    
        .panel-body {
            color: initial;
        }
    
        .panel {
            word-break: break-word;
        }
    
        .status_header {
            color: gray;
        }
    </style>
</head>

<body class="container">
    <h1 onclick="window.location='login.html'" target="_blank" class="navbar-brand"><i class="fa fa-cubes"></i>
        dunbar</h1>
    <div class='' id="intro">
        <p>
            Manage the users for the Dunbar connected apps.
        </p>
    </div>
    <div class='panel panel-info' name="block">
        <div>
            Logged in as <span id="agentLink">Not Logged In</span>
        </div>
        <h4> Dunbar Users List </h4>
        <ul id="userList">
            <li>
                <span class="username">bhaberbe</span>
                <input class="small" type="button" value="Action 1"/>
                <input class="small" type="button" value="Action 2"/>
                <input class="small" type="button" value="Action 3"/>
            </li>
            <li>
                <span class="username">cubap</span>
                <input class="small" type="button" value="Action 1"/>
                <input class="small" type="button" value="Action 2"/>
                <input class="small" type="button" value="Action 3"/>
            </li>
            <li>
                <span class="username">dunbarp</span>
                <input class="small" type="button" value="Action 1"/>
                <input class="small" type="button" value="Action 2"/>
                <input class="small" type="button" value="Action 3"/>
            </li>
            <li>
                <span class="username">federkob</span>
                <input class="small" type="button" value="Action 1"/>
                <input class="small" type="button" value="Action 2"/>
                <input class="small" type="button" value="Action 3"/>
            </li>
            <li>
                <span class="username">orielyr</span>
                <input class="small" type="button" value="Action 1"/>
                <input class="small" type="button" value="Action 2"/>
                <input class="small" type="button" value="Action 3"/>
            </li>
            <li>
                <span class="username">perrond</span>
                <input class="small" type="button" value="Action 1"/>
                <input class="small" type="button" value="Action 2"/>
                <input class="small" type="button" value="Action 3"/>
            </li>
            <li>
                <span class="username">tarasenkov</span>
                <input class="small" type="button" value="Action 1"/>
                <input class="small" type="button" value="Action 2"/>
                <input class="small" type="button" value="Action 3"/>
            </li>
            <li>
                <span class="username">buchnevichp</span>
                <input class="small" type="button" value="Action 1"/>
                <input class="small" type="button" value="Action 2"/>
                <input class="small" type="button" value="Action 3"/>
            </li>
            <li>
                <span class="username">faulkj</span>
                <input class="small" type="button" value="Action 1"/>
                <input class="small" type="button" value="Action 2"/>
                <input class="small" type="button" value="Action 3"/>
            </li>
            <li>
                <span class="username">bhaberbe</span>
                <input class="small" type="button" value="Action 1"/>
                <input class="small" type="button" value="Action 2"/>
                <input class="small" type="button" value="Action 3"/>
            </li>
        </ul>
    </div>
    <script src="https://cdn.auth0.com/js/auth0/9.19.0/auth0.min.js"></script>
    <script type="text/javascript" src="./script/heart.js"></script>
    <script type="text/javascript">

        const AUDIENCE = "https://cubap.auth0.com/api/v2/"
        const ISSUER_BASE_URL = "cubap.auth0.com"
        const CLIENTID = "z1DuwzGPYKmF7POW9LiAipO5MvKSDERM"
        const DUNBAR_REDIRECT = "http://dunbar-users.herokuapp.com/dunbar-users/manage.html"
        const DOMAIN = "cubap.auth0.com"
        const myURL = document.location.href

        let webAuth = null
        let manager = null

        //Keep these in session when appropriate, to help avoid as many async calls as possible.

        //This is an Auth0 Bearer, a management access token
        let token = sessionStorage.getItem("Dunbar-Token")
        //This is a RERUM v1 Agent
        let agent = sessionStorage.getItem("Agent-URI")
        //This is an Auth0 User Profile
        //TODO how do i know if this user is an admin?
        let user = sessionStorage.getItem("Dunbar-User")
        

        //If this is in the address bar, then it means we are resetting the user and token in storage.  Don't trust the ones you have.
        if (myURL.indexOf("access_token=") > -1) {
            //Auth0 Login Widget was successful and it redirect here with the access token in the URL.
            //Put the token in session storage and refresh the page.  We don't want it in the address bar.
            token = getURLHash("access_token")
            sessionStorage.setItem('Dunbar-Token', token)
            //document.location.href="login.html"
        }

        //You can trust the token.  However, it may have expired.
        if(token){
            //A token was in sessionStorage, so there was a login during this window session.
            let authenticator = new auth0.Authentication({
                "domain":     DOMAIN,
                "clientID":   CLIENTID,
                "audience":   AUDIENCE,
                "scope":"create:users read:users read:user_idp_tokens update:users delete:users read:roles create:roles update:roles delete:roles profile openid offline_access "
            })

            let webAuth = new auth0.WebAuth({
                "domain":     DOMAIN,
                "clientID":   CLIENTID,
                "audience":   AUDIENCE,
                "scope": "create:users read:users read:user_idp_tokens update:users delete:users read:roles create:roles update:roles delete:roles profile openid offline_access"
            })

            //An access token is stored. Let's use it to get THIS USER's info.  If it fails, the user needs to login again.
            authenticator.userInfo(token, async function(err, u){
                if(err){
                    console.error(err)
                    sessionStorage.removeItem('Agent-URI')
                    sessionStorage.removeItem('Dunbar-Token')
                    sessionStorage.removeItem('Dunbar-User')
                    agentLink.innerHTML = "Please login again.  Your session expired."
                    alert("You logged out or your session expired.  Try logging in again.")
                }
                else{
                    //If this user is an admin, get them a management token
                    //We need to add the roles using rules, much like we do for the agent info.
                    // There is an isAuthenticated checker
                    if(isAdmin(u)){
                        token = await getManagementToken()
                        sessionStorage.setItem('Dunbar-Token', token)
                        //sessionStorage.setItem('Dunbar-Management-Token', token)
                        //TODO start a heartbeat that refreshes the token?  Expires every 7200 seconds.
                        //startHeartbeat(webAuth)
                        userList.innerHTML = ""
                        let a = u["http://store.rerum.io/agent"]
                        agentLink.innerHTML = a
                        sessionStorage.setItem('Agent-URI', a)
                        sessionStorage.setItem('Dunbar-User', JSON.stringify(u))
                        let user_arr = await getAllUsers()
                        for(let u of user_arr){
                            //Add them to the <ul> with the buttons available to do actions on them.
                            let elem = `<li><span class="username">${u.username}</span>`
                            let buttons = `
                                <input class="small" type="button" value="Action 1"/>
                                <input class="small" type="button" value="Action 2"/>
                                <input class="small" type="button" value="Action 3"/>
                            `
                            elem += buttons + `</li>`
                            userList.innerHTML += elem
                        }       
                    }
                    else{
                        //I'ma make you login again.  Consider yourself punished.
                        sessionStorage.removeItem('Agent-URI')
                        sessionStorage.removeItem('Dunbar-Token')
                        sessionStorage.removeItem('Dunbar-User')
                        alert("You do not have proper permissions to manage the Dunbar Apps' Users.")
                    }
                    
                }
            })
        }
        else{
            //They need to log in!
            alert("You logged out or your session expired.  Try logging in again.")
        }

        /**
         * Auth0 redirects here with a bunch of info in hash variables.
         * This function allows you pull a single variable from the hash
         */  
        function getURLHash(variable, url=document.location.href) {
            var query = url.substr(url.indexOf("#")+1)
            var vars = query.split("&")
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=")
                if (pair[0] == variable) { return pair[1] }
            }
            return false
        }

        async function getAllUsers(){
            // ooo we need to add a query to this that filters for Dunbar Apps users only...right now all users are returned (even the bot)
            // https://auth0.com/docs/manage-users/user-search/user-search-query-syntax
            // We can search by app_metadata, user_metadata and profile info
            let users = await fetch('https://cubap.auth0.com/api/v2/users?q=app_metadata.app:"dla"', {
                method: 'GET', 
                cache: 'default',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type' : "application/json; charset=utf-8"
                }
            })
            .then(resp => resp.json())
            .catch(err => {
                console.err(err)
                return []
            })
            console.log("I found "+users.length+" users!")
            return users
        }

        async function getManagementToken(){
            let m_token = await fetch("/dunbar-users/manage/getManagementToken", {
                "method" : "GET",
                "cache" : "no-store",
                "headers" :{
                    "Authorization" : `Bearer ${sessionStorage.getItem("Dunbar-Token")}`
                }
            })
            .then(resp => resp.text())
            .catch(err => {
                console.log("Error getting management token")
                console.log(err)
                return ""
            })
            return m_token
        }

        async function assignAsPublic(userID){
            fetch(`/dunbar-users/manage/assignPublicRole/${userID}`)
            .then(resp => {
                if(resp.ok){
                    alert("Role was assigned")
                }
                else{
                    console.error(resp)
                    alert("Role failed to assign")
                }
            })
            .catch(err => {
                console.error(err)
                alert("Error assigning role")
            })  
        }

        function isAdmin(user){
            let roles = user["http://dunbar.rerum.io/user_roles"].roles ?? []
            return roles.includes("dunbar_user_admin")
        }

    </script>
</body>

</html>
